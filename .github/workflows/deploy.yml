name: Deploy to Dokploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Dokploy Deployment
        env:
          DOKPLOY_URL: ${{ secrets.DOKPLOY_URL }}
          DOKPLOY_API_KEY: ${{ secrets.DOKPLOY_API_KEY }}
          DOKPLOY_APP_ID: ${{ secrets.DOKPLOY_APP_ID }}
        run: |
          echo "üöÄ Starting deployment to Dokploy..."
          
          # Normalize URL (remove trailing slash)
          DOKPLOY_URL=$(echo "$DOKPLOY_URL" | sed 's:/*$::')
          
          echo "Dokploy URL: $DOKPLOY_URL"
          echo "Application ID: $DOKPLOY_APP_ID"
          echo "Endpoint: $DOKPLOY_URL/api/application.deploy"
          
          # Make the request and capture both body and status code
          # Dokploy uses x-api-key header and application.deploy endpoint
          http_code=$(curl -L -X POST "$DOKPLOY_URL/api/application.deploy" \
            -H "x-api-key: $DOKPLOY_API_KEY" \
            -H "Content-Type: application/json" \
            -H "accept: application/json" \
            -d "{\"applicationId\": \"$DOKPLOY_APP_ID\"}" \
            -w "%{http_code}" \
            -o /tmp/response_body.txt \
            -s)
          
          body=$(cat /tmp/response_body.txt 2>/dev/null || echo "")
          
          echo ""
          echo "=== Response Body ==="
          echo "$body"
          echo ""
          echo "=== HTTP Status Code ==="
          echo "$http_code"
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "‚úÖ Deployment triggered successfully!"
          else
            echo "‚ùå Deployment failed with status code: $http_code"
            if [ -n "$body" ]; then
              echo "Error details: $body"
            fi
            exit 1
          fi
